name: Example workflow for Python script scan using Snyk
on: push

jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4 # Updated to stable v4

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/python@master
        continue-on-error: true # Ensures the workflow continues even if vulnerabilities are found
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: code test
          # Fixed: Use github.workspace to ensure the file is written to a shared runner directory
          args: --sarif-file-output=${{ github.workspace }}/snyk.sarif
          
      - name: Count total number of vulnerabilities
        id: count_vars
        run: |
          # Fixed: Point jq to the exact same workspace path
          RESULTS_LENGTH=$(jq '.runs[0].results | length' ${{ github.workspace }}/snyk.sarif)
          echo "RESULTS_LENGTH=$RESULTS_LENGTH" >> $GITHUB_ENV
          echo "Total Vulnerabilities: $RESULTS_LENGTH"

      - name: Upload SARIF report
        uses: actions/upload-artifact@v4
        with:
          name: snyk-vulnerability-report
          path: ${{ github.workspace }}/snyk.sarif # Uploads the file so you can inspect it manually

      - name: Pass_or_Fail_the_job
        run: |
            # Fixed: Added quotes and explicit logic for the failure message
            if [ "$RESULTS_LENGTH" != "0" ] && [ "$RESULTS_LENGTH" != "" ]; then
                echo "Job Failed: $RESULTS_LENGTH vulnerabilities detected."
                exit 1
            else
                echo "Pass: No vulnerabilities found."
            fi